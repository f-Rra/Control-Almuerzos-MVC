@model SCA_MVC.ViewModels.ServicioActivoViewModel
@{
    ViewData["Title"] = "Servicio Activo";
    bool hayServicio = Model.ServicioActivo != null;
}

<div class="srv-wrap">

    <!-- ═══ 1. CONFIGURACIÓN DEL SERVICIO ═══ -->
    <div class="panel">
        <form asp-action="Iniciar" method="post" id="form-iniciar">
            <div class="config-row">
                <div class="cfg-title"><i class="bi bi-gear-fill"></i> Configuración del Servicio</div>
                <div class="cfg-sep"></div>
                <div class="cfg-inputs">
                    <div class="cfg-item">
                        <label>Lugar</label>
                        <select name="idLugar" disabled="@hayServicio">
                            @foreach (var lugar in Model.LugaresDisponibles)
                            {
                                <option value="@lugar.IdLugar" selected="@(hayServicio && Model.ServicioActivo.IdLugar == lugar.IdLugar)">
                                    @lugar.Nombre
                                </option>
                            }
                        </select>
                    </div>
                    <div class="cfg-item">
                        <label>Fecha</label>
                        <input type="date" value="@(hayServicio ? Model.ServicioActivo.Fecha.ToString("yyyy-MM-dd") : DateTime.Today.ToString("yyyy-MM-dd"))" readonly />
                    </div>
                    <div class="cfg-item">
                        <label>Proyección</label>
                        <input type="number" name="proyeccion" value="@(hayServicio ? Model.ServicioActivo.Proyeccion : 0)" min="0" readonly="@hayServicio" />
                    </div>
                    <div class="cfg-item">
                        <label>Invitados</label>
                        <input type="number" name="invitados" id="input-invitados-ui" value="@(hayServicio ? Model.ServicioActivo.TotalInvitados : 0)" min="0" />
                    </div>
                </div>
                <div class="cfg-sep"></div>
                <div class="cfg-btn-wrap">
                    @if (!hayServicio)
                    {
                        <button type="submit" class="btn-srv btn-iniciar"><i class="bi bi-play-fill"></i> Iniciar Servicio</button>
                    }
                    else
                    {
                        <button type="button" class="btn-srv btn-finalizar" onclick="confirmarFinServicio()"><i class="bi bi-stop-fill"></i> Finalizar Servicio</button>
                    }
                </div>
            </div>
        </form>
    </div>

    <!-- ═══ 2. BARRA DE ESTADO ═══ -->
    <div class="status-bar">
        <div class="st-card">
            <i class="bi bi-power ico-lg" style="color:@(hayServicio ? "var(--green)" : "#ddd")"></i>
            <div class="st-label">Estado</div>
            <div class="st-value @(hayServicio ? "activo" : "")">
                <span class="st-dot @(hayServicio ? "on" : "")"></span> @(hayServicio ? "ACTIVO" : "INACTIVO")
            </div>
        </div>
        <div class="st-card">
            <i class="bi bi-stopwatch ico-lg"></i>
            <div class="st-label">Duración</div>
            <div class="st-crono" id="cronometro">00:00:00</div>
            @if (hayServicio)
            {
                <input type="hidden" id="hora-inicio" value="@Model.ServicioActivo.Fecha.ToString("o")" />
            }
        </div>
        <div class="st-card">
            <i class="bi bi-graph-up ico-lg" style="color:#42A5F5"></i>
            <div class="st-label">Progreso</div>
            <div class="prog-row">
                <div class="prog-track">
                    <div class="prog-fill" id="progreso-barra" style="width:@Model.PorcentajeCobertura.ToString("0")%"></div>
                </div>
                <div class="prog-pct" id="progreso-texto">@Model.PorcentajeCobertura.ToString("0")%</div>
            </div>
        </div>
        <div class="st-card">
            <i class="bi bi-person-check ico-lg" style="color:var(--green)"></i>
            <div class="st-label">Registrados</div>
            <div class="st-big" id="count-registrados">@Model.RegistradosHoy</div>
        </div>
        <div class="st-card">
            <i class="bi bi-person-dash ico-lg" style="color:var(--red)"></i>
            <div class="st-label">Faltan</div>
            <div class="st-big" id="count-faltan">@Model.PendientesHoy</div>
        </div>
        <div class="st-card">
            <i class="bi bi-people-fill ico-lg"></i>
            <div class="st-label">Capacidad</div>
            <div class="st-big">@(Model.ServicioActivo?.Proyeccion ?? 0)</div>
        </div>
    </div>

    <!-- ═══ 3. REGISTRO DE COMENSALES ═══ -->
    @if (hayServicio)
    {
        <div class="panel registro-section" id="seccion-registro">
            <div class="registro-inner">
                <div class="ph">
                    <h2><i class="bi bi-upc-scan"></i> Registro de Comensales</h2>
                </div>
                <div class="rfid-row">
                    <input class="rfid-input" id="rfid-input" placeholder="Escanear credencial..." autofocus />
                    <button class="btn-registrar" onclick="registrarPorCredencial()">
                        <i class="bi bi-arrow-return-left"></i> Ingresar Registro
                    </button>
                </div>
                <div class="table-wrap">
                    <table class="reg-table" id="tabla-registros">
                        <thead>
                            <tr>
                                <th style="width:40px">#</th>
                                <th>Empleado</th>
                                <th>Empresa</th>
                                <th style="width:90px">Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.UltimosRegistros.Count; i++)
                            {
                                var reg = Model.UltimosRegistros[i];
                                <tr>
                                    <td class="td-num">@(Model.RegistradosHoy - i)</td>
                                    <td>
                                        <div class="td-emp-cell">
                                            <div class="td-emp-ico"><i class="bi bi-person-fill"></i></div>
                                            <span class="td-empleado">@(reg.Empleado?.Nombre ?? "Empleado") @(reg.Empleado?.Apellido ?? "")</span>
                                        </div>
                                    </td>
                                    <td class="td-empresa">@(reg.Empleado?.Empresa?.Nombre ?? "-")</td>
                                    <td class="td-hora">@reg.Hora.ToString(@"hh\:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <form asp-action="Finalizar" method="post" id="form-finalizar" style="display:none">
            <input type="hidden" name="idServicio" value="@Model.ServicioActivo.IdServicio" />
            <input type="hidden" name="invitados" id="input-invitados" value="0" />
        </form>
    }
    else
    {
        <div class="panel registro-section info-vacia">
            <div class="text-center py-5 opacity-50">
                <i class="bi bi-info-circle fs-1"></i>
                <p class="mt-3">Inicie un servicio para comenzar el registro de comensales.</p>
            </div>
        </div>
    }

</div> <!-- /srv-wrap -->

@section Scripts {
    <script>
        // Lógica del Cronómetro
        if (document.getElementById('hora-inicio')) {
            const inicio = new Date(document.getElementById('hora-inicio').value);
            setInterval(() => {
                const ahora = new Date();
                const diff = new Date(ahora - inicio);
                const h = String(diff.getUTCHours()).padStart(2, '0');
                const m = String(diff.getUTCMinutes()).padStart(2, '0');
                const s = String(diff.getUTCSeconds()).padStart(2, '0');
                document.getElementById('cronometro').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        // Registro por credencial
        async function registrarPorCredencial() {
            const input = document.getElementById('rfid-input');
            const credencial = input.value.trim();
            if (!credencial) return;

            const response = await fetch('/Servicio/Registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `credencial=${credencial}&idServicio=@(Model.ServicioActivo?.IdServicio ?? 0)&idLugar=@(Model.ServicioActivo?.IdLugar ?? 0)`
            });

            const data = await response.json();
            if (data.success) {
                // Notificación Toast (requiere site.js)
                if (window.showToast) showToast('Éxito', `${data.nombre} registrado`, 'success');

                // Actualizar tabla (prepend)
                const tbody = document.querySelector('#tabla-registros tbody');
                const count = parseInt(document.getElementById('count-registrados').textContent) + 1;
                const newRow = `
                    <tr>
                        <td class="td-num">${count}</td>
                        <td><div class="td-emp-cell"><div class="td-emp-ico"><i class="bi bi-person-fill"></i></div><span class="td-empleado">${data.nombre}</span></div></td>
                        <td class="td-empresa">${data.empresa}</td>
                        <td class="td-hora">${data.hora}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('afterbegin', newRow);

                // Actualizar contadores
                document.getElementById('count-registrados').textContent = count;
                const proyeccion = @(Model.ServicioActivo?.Proyeccion ?? 1);
                const faltan = Math.max(0, proyeccion - count);
                document.getElementById('count-faltan').textContent = faltan;
                const pct = Math.min(100, Math.round((count / proyeccion) * 100));
                document.getElementById('progreso-barra').style.width = pct + '%';
                document.getElementById('progreso-texto').textContent = pct + '%';

                input.value = '';
                input.focus();
            } else {
                if (window.showToast) showToast('Error', data.message, 'error');
                input.select();
            }
        }

        // Enter en el input RFID
        document.getElementById('rfid-input')?.addEventListener('keydown', e => {
            if (e.key === 'Enter') registrarPorCredencial();
        });

        function confirmarFinServicio() {
            // Sincronizar invitados antes de enviar
            const invitados = document.getElementById('input-invitados-ui').value;
            document.getElementById('input-invitados').value = invitados;

            // Usar el modal de confirmación de site.js si existe
            if (window.showConfirm) {
                showConfirm(`¿Desea finalizar el servicio actual con ${invitados} invitados?`, "Finalizar Servicio", () => {
                   document.getElementById('form-finalizar').submit();
                });
            } else if (confirm(`¿Finalizar servicio con ${invitados} invitados?`)) {
                document.getElementById('form-finalizar').submit();
            }
        }
    </script>
}
